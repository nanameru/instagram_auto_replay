<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>インスタグラムDM履歴管理アプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* 全体のスタイル */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
        }
        
        /* ヘッダー */
        .navbar {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            background: #ffffff;
        }
        
        /* カラー変数 */
        :root {
            --primary-color: #3b5998; /* Instagram風の青 */
            --secondary-color: #833AB4; /* Instagram風の紫 */
            --accent-color: #E1306C; /* Instagram風のピンク */
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #dee2e6;
            --hover-color: #e9ecef;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }
        
        /* サイドバー */
        #sidebar {
            height: 100vh;
            overflow-y: auto;
            background-color: #fff;
            border-right: 1px solid var(--border-color);
            padding: 1.25rem;
            box-shadow: 2px 0px 10px rgba(0, 0, 0, 0.03);
        }
        
        /* サイドバー内の要素のスタイルを追加 */
        .user-icon {
            text-align: center;
            margin-bottom: 1.5rem;
            padding-top: 1rem;
        }
        
        .sidebar-item {
            padding: 0.75rem 1rem;
            color: var(--dark-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .sidebar-item i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }
        
        .sidebar-item:hover {
            background-color: var(--hover-color);
            transform: translateX(3px);
        }
        
        .sidebar-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .account-switcher {
            border-top: 1px solid var(--border-color);
            padding-top: 1.25rem;
            margin-top: 2rem;
        }
        
        .account-option {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 0.25rem;
            transition: all 0.2s ease;
        }
        
        .account-option:hover {
            background-color: var(--hover-color);
        }
        
        .account-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
        }
        
        .account-circle i {
            font-size: 0.9rem;
        }
        
        /* 顧客リスト */
        .customer-list-container {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .customer-list {
            max-height: calc(100vh - 220px);
            overflow-y: auto;
        }
        
        .customer-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }
        
        .customer-item:hover {
            background-color: var(--hover-color);
            border-color: var(--border-color);
            transform: translateY(-2px);
        }
        
        .customer-item.active {
            background-color: rgba(59, 89, 152, 0.08); /* primary color with opacity */
            border-left: 3px solid var(--primary-color);
            padding-left: 9px; /* Compensate for border */
        }
        
        .customer-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .customer-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .customer-info {
            flex: 1;
        }
        
        .customer-name {
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .customer-username {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* メッセージ */
        .message-container {
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 18px;
            margin-bottom: 15px;
            max-width: 80%;
            word-break: break-word;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 1.5;
        }
        
        .message-customer {
            background-color: #e9ecef;
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }
        
        .message-user {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            align-self: flex-end;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .message.sending {
            opacity: 0.7;
        }
        
        .timestamp {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 5px;
            text-align: right;
        }
        
        /* 編集ボタン */
        .edit-message-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: #6c757d;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.8rem;
        }
        
        .message:hover .edit-message-btn {
            opacity: 1;
        }
        
        .message-user .edit-message-btn {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* 編集モード */
        .message.editing {
            padding-bottom: 40px;
        }
        
        .edit-message-input {
            width: 100%;
            border: 1px solid #ced4da;
            border-radius: 8px;
            padding: 8px 12px;
            margin-top: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .edit-message-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 89, 152, 0.25);
        }
        
        .edit-actions {
            position: absolute;
            bottom: 8px;
            right: 8px;
            display: flex;
        }
        
        .edit-actions button {
            margin-left: 5px;
            border: none;
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .edit-actions button:hover {
            transform: translateY(-2px);
        }
        
        .save-edit-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .cancel-edit-btn {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* 返信候補 */
        .reply-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .reply-suggestion {
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }
        
        .reply-suggestion:hover {
            background-color: var(--hover-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        /* メッセージ入力 */
        .message-input-container {
            position: relative;
        }
        
        .message-input {
            border-radius: 25px;
            padding-right: 50px;
            resize: none;
            overflow-y: auto;
            max-height: 100px;
            transition: all 0.2s;
            border: 1px solid var(--border-color);
        }
        
        .message-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(59, 89, 152, 0.25);
            border-color: var(--primary-color);
        }
        
        .send-btn {
            position: absolute;
            right: 10px;
            bottom: 10px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
            color: white;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .send-btn:hover {
            transform: scale(1.1);
        }
        
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* ページカード */
        .card {
            border-radius: 10px;
            border: 1px solid var(--border-color);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            padding: 0.8rem 1.25rem;
        }
        
        .card-body {
            padding: 1.25rem;
        }
        
        /* フォーム要素 */
        .form-control {
            border-radius: 8px;
            padding: 0.6rem 0.75rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        
        .form-control:focus {
            box-shadow: 0 0 0 0.25rem rgba(59, 89, 152, 0.25);
            border-color: var(--primary-color);
        }
        
        .btn {
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: #344e86; /* slightly darker */
            border-color: #344e86;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-outline-primary:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* DMインポート関連 */
        .custom-file-upload {
            background-color: #fff;
            transition: all 0.3s ease;
            padding: 20px !important;
            border-style: dashed !important;
        }
        
        .custom-file-upload:hover {
            background-color: #f8f9fa;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        #htmlDropZone, #dropZone {
            border-style: dashed !important;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        #htmlDropZone:hover, #dropZone:hover,
        #htmlDropZone.border-primary, #dropZone.border-primary {
            background-color: rgba(59, 89, 152, 0.05);
            border-color: var(--primary-color) !important;
        }
        
        .nav-tabs .nav-item .nav-link {
            color: var(--dark-color);
            font-weight: 500;
            border: none;
            padding: 0.8rem 1.2rem;
            transition: all 0.2s;
        }
        
        .nav-tabs .nav-item .nav-link.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            background-color: transparent;
        }
        
        .nav-tabs .nav-item .nav-link:hover:not(.active) {
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-sm .nav-link {
            padding: 0.4rem 0.8rem !important;
            font-size: 0.9rem;
        }
        
        /* アラート */
        .alert {
            border-radius: 8px;
            padding: 0.75rem 1.25rem;
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* アカウント設定 */
        .access-key-container {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .access-key-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .status-set {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-not-set {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* レスポンシブ */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                width: 280px;
                height: 100%;
                z-index: 1050;
                transition: all 0.3s ease;
            }
            
            #sidebar.active {
                left: 0;
            }
            
            .overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1040;
            }
            
            .overlay.active {
                display: block;
            }
            
            .sidebar-toggle {
                display: block !important;
            }
            
            .main-content {
                margin-left: 0 !important;
            }
        }
        
        /* ローディングスピナー */
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            border-width: 0.2em;
        }
        
        /* ユーティリティクラス */
        .cursor-pointer {
            cursor: pointer;
        }
        
        .transition-all {
            transition: all 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- モバイルメニュートグル -->
    <button class="mobile-menu-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- サイドバーオーバーレイ -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <div class="col-lg-3 sidebar" id="sidebar">
                <div class="user-icon">
                    <i class="fas fa-user fa-2x text-primary"></i>
                </div>
                <div class="text-center mb-4">現在のユーザー</div>
                
                <div class="sidebar-item active">
                    <i class="fas fa-chart-line"></i>
                    ダッシュボード
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-users"></i>
                    顧客一覧
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-user-friends"></i>
                    チームメンバー
                </div>
                <div class="sidebar-item">
                    <i class="fas fa-cog"></i>
                    アカウント設定
                </div>
                
                <div class="account-switcher mt-5">
                    <div class="mb-2 ms-3">
                        <i class="fas fa-exchange-alt me-2"></i>
                        アカウント切り替え
                    </div>
                    <div class="account-option">
                        <div class="account-circle">
                            <i class="fas fa-user-circle text-primary"></i>
                        </div>
                        アカウント1
                    </div>
                    <div class="account-option">
                        <div class="account-circle">
                            <i class="fas fa-user-circle text-primary"></i>
                        </div>
                        アカウント2
                    </div>
                    <div class="account-option">
                        <div class="account-circle">
                            <i class="fas fa-plus text-primary"></i>
                        </div>
                        新規追加
                    </div>
                </div>
            </div>
            
            <!-- メインコンテンツ -->
            <div class="col-lg-9 p-4 main-content">
                <div class="row">
                    <!-- 顧客リスト -->
                    <div class="col-md-5 customer-list-container">
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-4">
                                    <i class="fas fa-users me-2 text-primary"></i>顧客アカウント一覧
                                </h5>
                                <div class="input-group mb-3">
                                    <input type="text" class="form-control" placeholder="顧客検索..." aria-label="顧客検索" id="customer-search">
                                    <button class="btn btn-outline-secondary" type="button" id="search-button">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                
                                <div class="customer-list" id="customer-list">
                                    <!-- 顧客リストは動的に生成されます -->
                                </div>
                            </div>
                        </div>

                        <!-- インスタグラムDMインポート機能 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <h5 class="card-title mb-3">
                                    <i class="fas fa-file-import me-2 text-primary"></i>DMインポート
                                </h5>
                                
                                <!-- タブナビゲーション -->
                                <ul class="nav nav-tabs mb-3" id="importTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="screenshot-tab" data-bs-toggle="tab" data-bs-target="#screenshot" type="button" role="tab" aria-controls="screenshot" aria-selected="true">
                                            <i class="fas fa-image me-1"></i>スクリーンショット
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="html-tab" data-bs-toggle="tab" data-bs-target="#html" type="button" role="tab" aria-controls="html" aria-selected="false">
                                            <i class="fas fa-code me-1"></i>HTML
                                        </button>
                                    </li>
                                </ul>
                                
                                <!-- タブコンテンツ -->
                                <div class="tab-content" id="importTabsContent">
                                    <!-- スクリーンショットタブ -->
                                    <div class="tab-pane fade show active" id="screenshot" role="tabpanel" aria-labelledby="screenshot-tab">
                                        <p class="text-muted small mb-3">
                                            <i class="fas fa-info-circle me-1"></i>
                                            インスタグラムDMのスクリーンショットをアップロードしてデータベースに保存します
                                        </p>
                                        
                                        <div class="mb-3">
                                            <div class="custom-file-upload border rounded p-3 text-center" id="dropZone">
                                                <i class="fas fa-cloud-upload-alt fa-2x text-primary mb-2"></i>
                                                <p class="mb-1">ここにファイルをドロップまたは</p>
                                                <input type="file" id="screenshotUpload" accept="image/*" class="d-none">
                                                <label for="screenshotUpload" class="btn btn-sm btn-outline-primary">ファイルを選択</label>
                                            </div>
                                        </div>
                                        
                                        <div id="screenshot-preview" class="mb-3 d-none">
                                            <img src="#" class="img-fluid border rounded" id="preview-image">
                                            <div class="d-flex justify-content-end mt-2">
                                                <button class="btn btn-sm btn-outline-danger me-2" id="remove-screenshot">
                                                    <i class="fas fa-times"></i> 削除
                                                </button>
                                                <button class="btn btn-sm btn-primary" id="process-screenshot">
                                                    <i class="fas fa-cogs"></i> 処理開始
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div id="screenshot-status" class="d-none alert alert-info">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            スクリーンショットを処理中...
                                        </div>
                                        
                                        <div id="screenshot-result" class="d-none">
                                            <div class="alert alert-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <span id="screenshot-result-text"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- HTMLタブ -->
                                    <div class="tab-pane fade" id="html" role="tabpanel" aria-labelledby="html-tab">
                                        <p class="text-muted small mb-3">
                                            <i class="fas fa-info-circle me-1"></i>
                                            インスタグラムDMのHTMLをペーストまたはファイルとしてアップロード
                                        </p>
                                        
                                        <!-- マルチタブでファイルアップロードとテキスト入力を分割 -->
                                        <ul class="nav nav-tabs nav-sm mb-3" id="htmlInputTabs" role="tablist">
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link active" id="html-file-tab" data-bs-toggle="tab" data-bs-target="#html-file" type="button" role="tab" aria-controls="html-file" aria-selected="true">
                                                    <i class="fas fa-file me-1"></i>ファイル
                                                </button>
                                            </li>
                                            <li class="nav-item" role="presentation">
                                                <button class="nav-link" id="html-paste-tab" data-bs-toggle="tab" data-bs-target="#html-paste" type="button" role="tab" aria-controls="html-paste" aria-selected="false">
                                                    <i class="fas fa-paste me-1"></i>テキスト貼り付け
                                                </button>
                                            </li>
                                        </ul>
                                        
                                        <div class="tab-content" id="htmlInputTabsContent">
                                            <!-- ファイルアップロードタブ -->
                                            <div class="tab-pane fade show active" id="html-file" role="tabpanel" aria-labelledby="html-file-tab">
                                                <div class="custom-file-upload border rounded p-3 text-center mb-3" id="htmlDropZone">
                                                    <i class="fas fa-file-code fa-2x text-primary mb-2"></i>
                                                    <p class="mb-1">HTMLファイルをドラッグ&ドロップまたは</p>
                                                    <input type="file" id="htmlUpload" accept=".html,.htm" class="d-none">
                                                    <label for="htmlUpload" class="btn btn-sm btn-outline-primary">ファイルを選択</label>
                                                </div>
                                                <div id="html-file-info" class="alert alert-info d-none">
                                                    <i class="fas fa-info-circle me-2"></i>
                                                    <span id="html-file-name"></span>
                                                </div>
                                            </div>
                                            
                                            <!-- テキスト貼り付けタブ -->
                                            <div class="tab-pane fade" id="html-paste" role="tabpanel" aria-labelledby="html-paste-tab">
                                                <textarea class="form-control" id="htmlContent" rows="7" placeholder="HTMLをここにペースト..."></textarea>
                                            </div>
                                        </div>
                                        
                                        <div class="d-grid mt-3">
                                            <button class="btn btn-primary" id="process-html">
                                                <i class="fas fa-cogs"></i> 処理開始
                                            </button>
                                        </div>
                                        
                                        <div id="html-status" class="d-none alert alert-info mt-3">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            HTMLを処理中...
                                        </div>
                                        
                                        <div id="html-result" class="d-none mt-3">
                                            <div class="alert alert-success">
                                                <i class="fas fa-check-circle me-2"></i>
                                                <span id="html-result-text"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DMやり取り履歴 -->
                    <div class="col-md-7">
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-4">
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-comments me-2 text-primary"></i>DM履歴
                                    </h5>
                                    <div class="customer-info d-flex align-items-center" id="selected-customer-info">
                                        <div class="customer-avatar me-2">
                                            <img src="https://randomuser.me/api/portraits/men/1.jpg" alt="顧客アバター" id="selected-customer-avatar">
                                        </div>
                                        <div>
                                            <div class="customer-name" id="selected-customer-name">顧客名</div>
                                            <div class="customer-username" id="selected-customer-username">@username</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- DM同期ボタン -->
                                <div class="mb-3" id="dm-sync-container">
                                    <button id="sync-dm-button" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-sync-alt me-1"></i>DM同期
                                    </button>
                                    <span id="sync-status" class="ms-2"></span>
                                </div>
                                
                                <!-- メッセージ表示領域 -->
                                <div class="message-container d-flex flex-column" id="message-container">
                                    <!-- メッセージは動的に生成されます -->
                                </div>
                                
                                <!-- 返信候補 -->
                                <div class="reply-suggestions" id="reply-suggestions-container">
                                    <div class="reply-suggestion-label mb-2 text-muted">
                                        <small><i class="fas fa-lightbulb me-1"></i>返信候補:</small>
                                    </div>
                                    <div class="reply-suggestions" id="reply-suggestions">
                                        <!-- 返信候補は動的に生成されます -->
                                    </div>
                                </div>
                                
                                <!-- メッセージ入力 -->
                                <div class="input-group message-input-container">
                                    <textarea class="form-control message-input" id="message-input" placeholder="メッセージを入力..." rows="2"></textarea>
                                    <button class="btn send-btn" id="send-message-btn" disabled>
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- アカウント設定 -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-cog me-2 text-primary"></i>アカウント設定
                                        </h5>
                                        
                                        <div class="access-key-container mb-3">
                                            <div class="d-flex align-items-center mb-2">
                                                <h6 class="mb-0">Instagramアクセスキー</h6>
                                                <span id="access-key-status" class="access-key-status ms-2">
                                                    <i class="fas fa-circle-notch fa-spin"></i> 確認中...
                                                </span>
                                            </div>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="access-key-input" placeholder="アクセスキーを入力...">
                                                <button class="btn btn-primary" id="save-access-key">
                                                    <i class="fas fa-save me-1"></i>保存
                                                </button>
                                            </div>
                                            <small class="text-muted mt-2 d-block">
                                                <i class="fas fa-info-circle me-1"></i>
                                                APIからDMを取得するために必要です
                                            </small>
                                            <div id="save-key-message" class="mt-2 small"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script>
        // ローカル表示用のダミー google.script.run オブジェクト
        // google オブジェクトが存在しない場合にのみ定義
        if (typeof google === 'undefined' || !google.script) {
            window.google = {
                script: {
                    run: {
                        _successHandler: null,
                        _failureHandler: null,
                        withSuccessHandler: function(handler) {
                            this._successHandler = handler;
                            return this;
                        },
                        withFailureHandler: function(handler) {
                            this._failureHandler = handler;
                            return this;
                        },
                        // ダミーの顧客データを返す
                        getCustomers: function() {
                            const dummyCustomers = {
                                'customer1': { id: 'customer1', name: '顧客A (ダミー)', username: '@customer_a_dummy', avatar: 'https://via.placeholder.com/50/007bff/ffffff?text=A', messages: [] },
                                'customer2': { id: 'customer2', name: '顧客B (ダミー)', username: '@customer_b_dummy', avatar: 'https://via.placeholder.com/50/6c757d/ffffff?text=B', messages: [] },
                                'customer3': { id: 'customer3', name: '顧客C (ダミー)', username: '@customer_c_dummy', avatar: 'https://via.placeholder.com/50/28a745/ffffff?text=C', messages: [] }
                            };
                            if (this._successHandler) {
                                console.log("[ダミー] getCustomers を呼び出しました。");
                                setTimeout(() => {
                                    try {
                                        this._successHandler(dummyCustomers);
                                    } catch (e) {
                                        console.error("Success handler for getCustomers failed:", e);
                                        if (this._failureHandler) this._failureHandler(e);
                                    }
                                    this._successHandler = null; // ハンドラをリセット
                                    this._failureHandler = null;
                                }, 100); // 非同期っぽく見せるための遅延
                            } else {
                                this._successHandler = null;
                                this._failureHandler = null;
                            }
                            return this; // Chainingを可能にする
                        },
                        // ダミーの顧客詳細データを返す
                        getCustomer: function(customerId) {
                             const dummyCustomerData = {
                                'customer1': {
                                    id: 'customer1', name: '顧客A (ダミー)', username: '@customer_a_dummy', avatar: 'https://via.placeholder.com/50/007bff/ffffff?text=A',
                                    messages: [
                                        { sender: 'customer', text: 'こんにちは！ (ダミー)', timestamp: '10:00' },
                                        { sender: 'user', text: 'お問い合わせありがとうございます。(ダミー)', timestamp: '10:01' },
                                        { sender: 'customer', text: 'これは長いメッセージのテストです。折り返しが発生するかどうかを確認しています。(ダミー)', timestamp: '10:05' },
                                    ]
                                },
                                'customer2': {
                                    id: 'customer2', name: '顧客B (ダミー)', username: '@customer_b_dummy', avatar: 'https://via.placeholder.com/50/6c757d/ffffff?text=B',
                                    messages: [
                                        { sender: 'customer', text: '質問があります。(ダミー)', timestamp: '11:30' },
                                    ]
                                },
                                 'customer3': {
                                    id: 'customer3', name: '顧客C (ダミー)', username: '@customer_c_dummy', avatar: 'https://via.placeholder.com/50/28a745/ffffff?text=C',
                                    messages: [] // メッセージなしのテスト
                                }
                            };
                            if (this._successHandler) {
                                console.log(`[ダミー] getCustomer(${customerId}) を呼び出しました。`);
                                setTimeout(() => {
                                    try {
                                        this._successHandler(dummyCustomerData[customerId] || null);
                                    } catch(e) {
                                        console.error(`Success handler for getCustomer(${customerId}) failed:`, e);
                                        if(this._failureHandler) this._failureHandler(e);
                                    }
                                     this._successHandler = null;
                                     this._failureHandler = null;
                                }, 100);
                            } else {
                                this._successHandler = null;
                                this._failureHandler = null;
                            }
                             return this;
                        },
                        // ダミーの返信候補を返す
                        getReplySuggestions: function(customerId) {
                            const dummySuggestions = ['承知しました。(ダミー)', '確認します。(ダミー)', 'ありがとうございます！(ダミー)'];
                            if (this._successHandler) {
                                 console.log(`[ダミー] getReplySuggestions(${customerId}) を呼び出しました。`);
                                 setTimeout(() => {
                                     try {
                                        this._successHandler(dummySuggestions);
                                     } catch(e) {
                                        console.error(`Success handler for getReplySuggestions(${customerId}) failed:`, e);
                                        if(this._failureHandler) this._failureHandler(e);
                                     }
                                     this._successHandler = null;
                                     this._failureHandler = null;
                                 }, 100);
                            } else {
                                this._successHandler = null;
                                this._failureHandler = null;
                            }
                             return this;
                        },
                        // 常に成功を返す (編集)
                        editMessageInSheet: function(customerId, oldText, newText) {
                            console.log(`[ダミー] editMessageInSheet 呼び出し: customerId=${customerId}, oldText=${oldText}, newText=${newText}`);
                            if (this._successHandler) {
                                 setTimeout(() => {
                                     try {
                                        this._successHandler(true); // 成功したことにする
                                     } catch (e) {
                                         console.error("Success handler for editMessageInSheet failed:", e);
                                         if (this._failureHandler) this._failureHandler(e);
                                     }
                                     this._successHandler = null;
                                     this._failureHandler = null;
                                 }, 100);
                            } else {
                                this._successHandler = null;
                                this._failureHandler = null;
                            }
                             return this;
                        },
                        // 常に成功を返す (送信)
                        sendMessageToCustomer: function(customerId, text) {
                            console.log(`[ダミー] sendMessageToCustomer 呼び出し: customerId=${customerId}, text=${text}`);
                             if (this._successHandler) {
                                 setTimeout(() => {
                                      try {
                                        this._successHandler(true); // 成功したことにする
                                     } catch (e) {
                                         console.error("Success handler for sendMessageToCustomer failed:", e);
                                         if (this._failureHandler) this._failureHandler(e);
                                     }
                                     this._successHandler = null;
                                     this._failureHandler = null;
                                 }, 100);
                            } else {
                                this._successHandler = null;
                                this._failureHandler = null;
                            }
                             return this;
                        },
                        // --- 追加: アカウント設定用ダミー関数 ---
                        saveAccessKey: function(key) {
                            console.log(`[ダミー] saveAccessKey 呼び出し: key=${key}`);
                            // ローカルストレージにダミーキー情報を保存 (オプション)
                            localStorage.setItem('dummy_access_key_set', 'true');
                            localStorage.setItem('dummy_access_key_last_four', key.slice(-4));

                            if (this._successHandler) {
                                setTimeout(() => {
                                    try {
                                        this._successHandler(true); // 常に成功を返す
                                    } catch (e) {
                                        console.error("Success handler for saveAccessKey failed:", e);
                                        if (this._failureHandler) this._failureHandler(e);
                                    }
                                    this._successHandler = null;
                                    this._failureHandler = null;
                                }, 500); // 少し遅延させる
                            } else {
                                this._successHandler = null;
                                this._failureHandler = null;
                            }
                            return this;
                        },
                        getAccessKeyInfo: function() {
                             console.log(`[ダミー] getAccessKeyInfo を呼び出しました。`);
                             // ローカルストレージからダミー情報を読み取る (オプション)
                             const isSet = localStorage.getItem('dummy_access_key_set') === 'true';
                             const lastFour = localStorage.getItem('dummy_access_key_last_four');
                             let status = "未設定";
                             if (isSet && lastFour) {
                                 status = `設定済み (末尾4桁: ${lastFour})`;
                             } else if (isSet) {
                                 status = "設定済み";
                             }

                             if (this._successHandler) {
                                 setTimeout(() => {
                                     try {
                                         this._successHandler(status); // 取得したステータスを返す
                                     } catch (e) {
                                         console.error("Success handler for getAccessKeyInfo failed:", e);
                                         if (this._failureHandler) this._failureHandler(e);
                                     }
                                     this._successHandler = null;
                                     this._failureHandler = null;
                                 }, 100);
                             } else {
                                 this._successHandler = null;
                                 this._failureHandler = null;
                             }
                             return this;
                        },
                         // --- 追加ここまで ---

                        // DM同期のダミー実装
                        syncDmsFromApi: function(customerId) {
                             console.log(`[ダミー] syncDmsFromApi 呼び出し: customerId=${customerId}`);
                             if (this._successHandler) {
                                 setTimeout(() => {
                                      try {
                                         // ここで true / false を変えて同期成功/失敗をテストできる
                                         this._successHandler(true); 
                                      } catch (e) {
                                          console.error("Success handler for syncDmsFromApi failed:", e);
                                          if (this._failureHandler) this._failureHandler(e);
                                      }
                                      this._successHandler = null;
                                      this._failureHandler = null;
                                 }, 1500); // 同期は少し時間がかかるように見せる
                             } else {
                                 this._successHandler = null;
                                 this._failureHandler = null;
                             }
                              return this;
                        }
                    }
                }
            };
        }

        // 現在選択されている顧客ID
        let currentCustomerId = null;
        
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // サーバーから顧客データを取得
            google.script.run.withSuccessHandler(function(customers) {
                // 顧客リストを生成
                generateCustomerList(customers);
                
                // 顧客IDが存在する場合は初期表示
                if (Object.keys(customers).length > 0) {
                    currentCustomerId = Object.keys(customers)[0];
                    updateCustomerView(currentCustomerId);
                }
            }).getCustomers();
            
            // レスポンシブサイドバーの制御
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const syncDmButton = document.getElementById('sync-dm-button');
            const syncStatus = document.getElementById('sync-status');
            
            if (sidebarToggle && sidebar && sidebarOverlay) {
                // トグルボタンのクリックイベント
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                    sidebarOverlay.style.display = sidebar.classList.contains('show') ? 'block' : 'none';
                });

                // ↓ Add click event for overlay to close sidebar
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('show');
                    this.style.display = 'none';
                });
            }
            
            // メッセージ送信（Enterキーまたは送信ボタン）
            const messageInput = document.querySelector('input[placeholder="メッセージを入力..."]');
            const sendButton = document.querySelector('.btn-primary[type="button"]');
            
            if (messageInput) {
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessageFromInput();
                    }
                });
            }
            
            if (sendButton) {
                sendButton.addEventListener('click', sendMessageFromInput);
            }
            
            // 返信候補ボタンのクリックイベント
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('reply-btn')) {
                    const replyText = e.target.textContent;
                    const inputField = document.querySelector('input[placeholder="メッセージを入力..."]');
                    if (inputField) {
                        inputField.value = replyText;
                        inputField.focus();
                    }
                }
            });
            
            // 編集ボタンのクリックイベント
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-message-btn') || 
                    (e.target.parentElement && e.target.parentElement.classList.contains('edit-message-btn'))) {
                    
                    // 編集ボタン要素を取得
                    const editBtn = e.target.classList.contains('edit-message-btn') ? 
                                    e.target : e.target.parentElement;
                    
                    // メッセージ要素を取得
                    const messageDiv = editBtn.parentNode;
                    
                    // 既に編集中の場合は何もしない
                    if (messageDiv.classList.contains('editing')) {
                        return;
                    }
                    
                    // メッセージのテキストを取得（編集ボタンのテキストを除く）
                    const messageText = messageDiv.textContent.trim();
                    
                    // 元のメッセージ内容を保存
                    messageDiv.setAttribute('data-original-text', messageText);
                    
                    // 編集用の入力フィールドを作成
                    const editInput = document.createElement('input');
                    editInput.className = 'edit-message-input';
                    editInput.value = messageText;
                    
                    // メッセージの内容をクリアして入力フィールドを追加
                    messageDiv.innerHTML = '';
                    messageDiv.appendChild(editInput);
                    messageDiv.classList.add('editing');
                    
                    // 編集アクションボタンを作成
                    const editActions = document.createElement('div');
                    editActions.className = 'edit-actions';
                    
                    const saveButton = document.createElement('button');
                    saveButton.className = 'save-edit-btn';
                    saveButton.textContent = '保存';
                    
                    const cancelButton = document.createElement('button');
                    cancelButton.className = 'cancel-edit-btn';
                    cancelButton.textContent = 'キャンセル';
                    
                    editActions.appendChild(saveButton);
                    editActions.appendChild(cancelButton);
                    messageDiv.appendChild(editActions);
                    
                    // 入力フィールドにフォーカスを当てる
                    editInput.focus();
                    
                    // 保存ボタンのクリックイベント
                    saveButton.addEventListener('click', function() {
                        const oldText = messageDiv.getAttribute('data-original-text');
                        const newText = editInput.value.trim();
                        
                        // 変更がない場合はキャンセル処理と同じ
                        if (newText === oldText) {
                            restoreMessage(messageDiv, oldText);
                            return;
                        }
                        
                        // 空のメッセージは許可しない
                        if (!newText) {
                            alert('メッセージを入力してください');
                            return;
                        }
                        
                        // サーバーにメッセージ編集を送信
                        google.script.run
                            .withSuccessHandler(function(success) {
                                if (success) {
                                    // 成功した場合、メッセージを更新
                                    restoreMessage(messageDiv, newText);
                                    // 顧客ビューを更新
                                    updateCustomerView(currentCustomerId);
                                } else {
                                    // 失敗した場合、元のメッセージに戻す
                                    alert('メッセージの編集に失敗しました');
                                    restoreMessage(messageDiv, oldText);
                                }
                            })
                            .withFailureHandler(function(error) {
                                alert('エラーが発生しました: ' + error);
                                restoreMessage(messageDiv, oldText);
                            })
                            .editMessageInSheet(currentCustomerId, oldText, newText);
                    });
                    
                    // キャンセルボタンのクリックイベント
                    cancelButton.addEventListener('click', function() {
                        const originalText = messageDiv.getAttribute('data-original-text');
                        restoreMessage(messageDiv, originalText);
                    });
                    
                    // Enterキーで保存、Escキーでキャンセル
                    editInput.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveButton.click();
                        } else if (e.key === 'Escape') {
                            e.preventDefault();
                            cancelButton.click();
                        }
                    });
                }
            });
            
            // メッセージを元の表示に戻す関数
            function restoreMessage(messageDiv, text) {
                messageDiv.textContent = text;
                messageDiv.classList.remove('editing');
                messageDiv.removeAttribute('data-original-text');
                
                // 編集ボタンを再追加
                const editBtn = document.createElement('button');
                editBtn.className = 'edit-message-btn';
                editBtn.innerHTML = '<i class="fas fa-pencil-alt"></i>';
                messageDiv.appendChild(editBtn);
                
                // タイムスタンプがあれば再追加
                const timestamp = messageDiv.getAttribute('data-timestamp');
                if (timestamp) {
                    const timeSpan = document.createElement('small');
                    timeSpan.className = 'timestamp';
                    timeSpan.textContent = timestamp;
                    messageDiv.appendChild(document.createElement('br'));
                    messageDiv.appendChild(timeSpan);
                }
            }
            
            // 顧客リストを生成する関数
            function generateCustomerList(customers) {
                const customerList = document.querySelector('.customer-list');
                if (!customerList) return;
                
                customerList.innerHTML = '';
                
                // 顧客IDの重複を防ぐためのセット
                const processedIds = new Set();
                
                // 顧客リストを生成
                for (const id in customers) {
                    // 既に処理済みのIDはスキップ
                    if (processedIds.has(id)) continue;
                    processedIds.add(id);
                    
                    const customer = customers[id];
                    const customerItem = document.createElement('div');
                    customerItem.className = 'customer-item';
                    customerItem.setAttribute('data-customer', customer.id);
                    
                    // 顧客情報
                    customerItem.innerHTML = `
                        <div class="customer-avatar">
                            <img src="${customer.avatar}" alt="${customer.name}">
                        </div>
                        <div class="customer-info">
                            <div class="customer-name">${customer.name}</div>
                            <div class="customer-username">${customer.username}</div>
                        </div>
                    `;
                    
                    customerList.appendChild(customerItem);
                    
                    // クリックイベント
                    customerItem.addEventListener('click', function() {
                        const customerId = this.getAttribute('data-customer');
                        currentCustomerId = customerId;
                        updateCustomerView(customerId);
                        
                        // モバイル表示時はサイドバーを閉じる
                        const sidebar = document.getElementById('sidebar');
                        if (window.innerWidth <= 991.98 && sidebar) {
                            sidebar.classList.remove('show');
                            sidebarOverlay.style.display = 'none';
                        }
                        
                        // アクティブクラスを設定
                        document.querySelectorAll('.customer-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        this.classList.add('active');
                    });
                }
            }
            
            // 顧客ビューを更新する関数
            function updateCustomerView(customerId) {
                if (!customerId) return;
                
                // サーバーから顧客データを取得
                google.script.run.withSuccessHandler(function(customer) {
                    if (!customer) return;
                    
                    // 顧客名を更新 (同期ボタンエリアに移動)
                    const customerHeader = document.getElementById('customer-username-display');
                    if (customerHeader) {
                        customerHeader.textContent = customer.username || '顧客を選択';
                    }

                    // ↓ 同期ボタンを表示 (顧客が選択されたら)
                    if (syncDmButton) {
                         syncDmButton.style.display = customer ? 'inline-block' : 'none';
                    }
                    // ↓ 同期ステータスをクリア
                    if(syncStatus) {
                        syncStatus.textContent = '';
                    }
                    
                    // メッセージコンテナをクリア
                    const messageContainer = document.querySelector('.message-container');
                    if (messageContainer) {
                        messageContainer.innerHTML = '';
                        
                        // メッセージを表示
                        if (customer.messages && customer.messages.length > 0) {
                            customer.messages.forEach(message => {
                                const messageDiv = document.createElement('div');
                                messageDiv.className = `message message-${message.sender}`;
                                messageDiv.textContent = message.text;
                                messageDiv.innerHTML += `<button class="edit-message-btn"><i class="fas fa-pencil-alt"></i></button>`;
                                
                                if (message.timestamp) {
                                    const timeSpan = document.createElement('small');
                                    timeSpan.className = 'timestamp';
                                    timeSpan.textContent = message.timestamp;
                                    messageDiv.appendChild(document.createElement('br'));
                                    messageDiv.appendChild(timeSpan);
                                }
                                
                                messageContainer.appendChild(messageDiv);
                            });
                        } else {
                            // メッセージがない場合
                            const noMessageDiv = document.createElement('div');
                            noMessageDiv.className = 'text-center text-muted my-5';
                            noMessageDiv.textContent = 'メッセージはありません';
                            messageContainer.appendChild(noMessageDiv);
                        }
                        
                        // スクロールを一番下に
                        messageContainer.scrollTop = messageContainer.scrollHeight;
                    }
                    
                    // 返信候補を更新
                    updateReplySuggestions(customerId);
                }).getCustomer(customerId);
            }
            
            // 返信候補を更新する関数
            function updateReplySuggestions(customerId) {
                // サーバーから返信候補を取得
                google.script.run.withSuccessHandler(function(suggestions) {
                    // 返信候補ボタンを更新
                    const suggestionsContainer = document.querySelector('.reply-suggestions');
                    if (suggestionsContainer) {
                        suggestionsContainer.innerHTML = '<h6 class="mb-3">返信候補</h6>';
                        
                        if (suggestions && suggestions.length > 0) {
                            const buttonsContainer = document.createElement('div');
                            buttonsContainer.className = 'reply-buttons';
                            
                            suggestions.forEach(suggestion => {
                                const button = document.createElement('button');
                                button.className = 'btn btn-outline-primary reply-btn mb-2 me-2';
                                button.textContent = suggestion;
                                buttonsContainer.appendChild(button);
                            });
                            
                            suggestionsContainer.appendChild(buttonsContainer);
                        } else {
                            const noSuggestions = document.createElement('p');
                            noSuggestions.className = 'text-muted';
                            noSuggestions.textContent = '返信候補はありません';
                            suggestionsContainer.appendChild(noSuggestions);
                        }
                    }
                }).getReplySuggestions(customerId);
            }
            
            // メッセージを送信する関数（入力フィールドから）
            function sendMessageFromInput() {
                const messageInput = document.querySelector('input[placeholder="メッセージを入力..."]');
                if (messageInput && messageInput.value.trim() !== '' && currentCustomerId) {
                    sendMessage(messageInput.value.trim());
                    messageInput.value = '';
                }
            }
            
            // メッセージを送信する関数
            function sendMessage(text) {
                if (!currentCustomerId) return;
                
                // 送信中の表示
                const messageContainer = document.querySelector('.message-container');
                if (messageContainer) {
                    const sendingDiv = document.createElement('div');
                    sendingDiv.className = 'message message-user sending';
                    sendingDiv.textContent = text;
                    sendingDiv.id = 'sending-message';
                    messageContainer.appendChild(sendingDiv);
                    messageContainer.scrollTop = messageContainer.scrollHeight;
                }
                
                // サーバーにメッセージを送信
                google.script.run
                    .withSuccessHandler(function(success) {
                        // 送信中表示を削除
                        const sendingMessage = document.getElementById('sending-message');
                        if (sendingMessage) {
                            sendingMessage.remove();
                        }
                        
                        if (success) {
                            // ビューを更新
                            updateCustomerView(currentCustomerId);
                        } else {
                            // エラーメッセージ
                            alert('メッセージの送信に失敗しました。');
                        }
                    })
                    .withFailureHandler(function(error) {
                        // 送信中表示を削除
                        const sendingMessage = document.getElementById('sending-message');
                        if (sendingMessage) {
                            sendingMessage.remove();
                        }
                        
                        // エラーメッセージ
                        alert('エラーが発生しました: ' + error);
                    })
                    .sendMessageToCustomer(currentCustomerId, text);
            }

            // ↓ 追加: 同期ボタンのクリックイベント
            if (syncDmButton) {
                syncDmButton.addEventListener('click', function() {
                    if (currentCustomerId) {
                        triggerDmSync(currentCustomerId);
                    }
                });
            }

            // ↓ 追加: DM同期をトリガーする関数
            function triggerDmSync(customerId) {
                if (!customerId) return;

                const button = document.getElementById('sync-dm-button');
                const statusSpan = document.getElementById('sync-status');

                if (button) button.disabled = true;
                if (statusSpan) statusSpan.textContent = '同期中...';

                google.script.run
                    .withSuccessHandler(function(success) {
                        if (button) button.disabled = false;
                        if (success) {
                            if (statusSpan) statusSpan.textContent = '同期完了';
                            // 同期が完了したらメッセージビューを更新
                            updateCustomerView(customerId);
                            // 少し経ったらステータス表示を消す
                             setTimeout(() => {
                                 if (statusSpan) statusSpan.textContent = '';
                             }, 3000);
                        } else {
                             if (statusSpan) statusSpan.textContent = '同期失敗';
                             alert('DMの同期に失敗しました。詳細はサーバーログを確認してください。');
                             // 少し経ったらステータス表示を消す
                             setTimeout(() => {
                                 if (statusSpan) statusSpan.textContent = '';
                             }, 5000);
                        }
                    })
                    .withFailureHandler(function(error) {
                        if (button) button.disabled = false;
                        if (statusSpan) statusSpan.textContent = '同期エラー';
                        alert('DM同期中にエラーが発生しました: ' + error);
                         // 少し経ったらステータス表示を消す
                         setTimeout(() => {
                             if (statusSpan) statusSpan.textContent = '';
                         }, 5000);
                    })
                    .syncDmsFromApi(customerId);
            }

            // --- アカウント設定関連 --- 
            const accessKeyInput = document.getElementById('access-key-input');
            const saveKeyButton = document.getElementById('save-access-key');
            const accessKeyStatus = document.getElementById('access-key-status');
            const saveKeyMessage = document.getElementById('save-key-message');

            // アクセスキー設定状況を取得して表示する関数
            function loadAccessKeyInfo() {
                if (typeof google !== 'undefined' && google.script && google.script.run) {
                    google.script.run
                        .withSuccessHandler(function(result) {
                            if (accessKeyStatus) {
                                if (result.isSet) {
                                    accessKeyStatus.textContent = '設定済み';
                                    accessKeyStatus.className = 'access-key-status status-set';
                                    accessKeyStatus.innerHTML = '<i class="fas fa-check-circle me-1"></i>設定済み';
                                } else {
                                    accessKeyStatus.textContent = '未設定';
                                    accessKeyStatus.className = 'access-key-status status-not-set';
                                    accessKeyStatus.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>未設定';
                                }
                            }
                        })
                        .withFailureHandler(function(error) {
                            if (accessKeyStatus) {
                                accessKeyStatus.textContent = 'エラー';
                                accessKeyStatus.className = 'access-key-status status-not-set';
                                accessKeyStatus.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>エラー';
                            }
                            console.error('アクセスキー情報の取得に失敗:', error);
                        })
                        .getAccessKeyInfo();
                } else {
                    // ローカル環境のシミュレーション
                    if (accessKeyStatus) {
                        accessKeyStatus.textContent = '未設定 (ローカル)';
                        accessKeyStatus.className = 'access-key-status status-not-set';
                        accessKeyStatus.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>未設定 (ローカル)';
                    }
                }
            }

            // 保存ボタンのクリックイベント
            if (saveKeyButton && accessKeyInput) {
                saveKeyButton.addEventListener('click', function() {
                    const newKey = accessKeyInput.value;
                    if (!newKey) {
                        if (saveKeyMessage) {
                            saveKeyMessage.textContent = 'アクセスキーを入力してください。';
                            saveKeyMessage.className = 'mt-2 text-danger';
                        }
                        return;
                    }

                    saveKeyButton.disabled = true;
                    if (saveKeyMessage) {
                        saveKeyMessage.textContent = '保存中...';
                        saveKeyMessage.className = 'mt-2 text-muted';
                    }

                    google.script.run
                        .withSuccessHandler(function(success) {
                            saveKeyButton.disabled = false;
                            if (success) {
                                if (saveKeyMessage) {
                                    saveKeyMessage.textContent = 'アクセスキーを保存しました。';
                                    saveKeyMessage.className = 'mt-2 text-success';
                                }
                                accessKeyInput.value = ''; // 入力欄をクリア
                                loadAccessKeyInfo(); // 表示を更新
                            } else {
                                if (saveKeyMessage) {
                                    saveKeyMessage.textContent = 'アクセスキーの保存に失敗しました。';
                                    saveKeyMessage.className = 'mt-2 text-danger';
                                }
                            }
                            // メッセージを数秒後に消す
                            setTimeout(() => {
                                if (saveKeyMessage) saveKeyMessage.textContent = '';
                            }, 5000);
                        })
                        .withFailureHandler(function(error) {
                            saveKeyButton.disabled = false;
                            if (saveKeyMessage) {
                                saveKeyMessage.textContent = '保存中にエラーが発生しました。';
                                saveKeyMessage.className = 'mt-2 text-danger';
                            }
                            console.error('アクセスキーの保存に失敗:', error);
                            // メッセージを数秒後に消す
                            setTimeout(() => {
                                if (saveKeyMessage) saveKeyMessage.textContent = '';
                            }, 5000);
                        })
                        .saveAccessKey(newKey);
                });
            }

            // 初期読み込み時にアクセスキー情報を取得
            loadAccessKeyInfo();

            // --- DMインポート機能のJS ---
            
            // ファイルドロップゾーンの設定
            const dropZone = document.getElementById('dropZone');
            const screenshotUpload = document.getElementById('screenshotUpload');
            const previewImage = document.getElementById('preview-image');
            const screenshotPreview = document.getElementById('screenshot-preview');
            const removeScreenshotBtn = document.getElementById('remove-screenshot');
            const processScreenshotBtn = document.getElementById('process-screenshot');
            const screenshotStatus = document.getElementById('screenshot-status');
            const screenshotResult = document.getElementById('screenshot-result');
            const screenshotResultText = document.getElementById('screenshot-result-text');
            
            let currentScreenshot = null;
            
            // ドラッグ&ドロップのイベント
            if (dropZone) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });
                
                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });
                
                function highlight() {
                    dropZone.classList.add('border-primary');
                }
                
                function unhighlight() {
                    dropZone.classList.remove('border-primary');
                }
                
                // ドロップ時の処理
                dropZone.addEventListener('drop', handleDrop, false);
                
                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleFiles(files);
                }
            }
            
            // ファイル選択イベント
            if (screenshotUpload) {
                screenshotUpload.addEventListener('change', function() {
                    handleFiles(this.files);
                });
            }
            
            // 画像ファイル処理
            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            currentScreenshot = e.target.result;
                            displayScreenshot(currentScreenshot);
                        };
                        
                        reader.readAsDataURL(file);
                    } else {
                        alert('画像ファイルを選択してください');
                    }
                }
            }
            
            // スクリーンショットを表示
            function displayScreenshot(imageData) {
                if (previewImage && screenshotPreview) {
                    previewImage.src = imageData;
                    screenshotPreview.classList.remove('d-none');
                }
            }
            
            // スクリーンショット削除ボタン
            if (removeScreenshotBtn) {
                removeScreenshotBtn.addEventListener('click', function() {
                    currentScreenshot = null;
                    if (screenshotPreview) {
                        screenshotPreview.classList.add('d-none');
                    }
                    if (screenshotUpload) {
                        screenshotUpload.value = '';
                    }
                });
            }
            
            // スクリーンショット処理ボタン
            if (processScreenshotBtn) {
                processScreenshotBtn.addEventListener('click', function() {
                    if (!currentScreenshot) return;
                    
                    // Base64形式の画像データからBase64部分のみを抽出
                    const base64Data = currentScreenshot.split(',')[1];
                    
                    // 処理中表示
                    if (screenshotStatus) screenshotStatus.classList.remove('d-none');
                    if (screenshotResult) screenshotResult.classList.add('d-none');
                    
                    // ローカル環境シミュレーション
                    if (typeof google !== 'undefined' && google.script && google.script.run) {
                        // 実際のサーバー側処理
                        google.script.run
                            .withSuccessHandler(function(result) {
                                // 処理中表示を非表示
                                if (screenshotStatus) screenshotStatus.classList.add('d-none');
                                
                                // 結果表示
                                if (screenshotResult && screenshotResultText) {
                                    if (result.success) {
                                        screenshotResult.classList.remove('d-none');
                                        screenshotResult.querySelector('div').className = 'alert alert-success';
                                        screenshotResultText.textContent = `成功: ${result.messageCount}件のメッセージを保存しました。`;
                                        
                                        // 顧客リストを更新
                                        updateCustomerList();
                                        
                                        // 処理完了したらプレビューをクリア
                                        setTimeout(() => {
                                            if (removeScreenshotBtn) removeScreenshotBtn.click();
                                        }, 1000);
                                    } else {
                                        screenshotResult.classList.remove('d-none');
                                        screenshotResult.querySelector('div').className = 'alert alert-danger';
                                        screenshotResultText.textContent = `エラー: ${result.error}`;
                                    }
                                }
                            })
                            .withFailureHandler(function(error) {
                                // 処理中表示を非表示
                                if (screenshotStatus) screenshotStatus.classList.add('d-none');
                                
                                // エラー表示
                                if (screenshotResult && screenshotResultText) {
                                    screenshotResult.classList.remove('d-none');
                                    screenshotResult.querySelector('div').className = 'alert alert-danger';
                                    screenshotResultText.textContent = `エラー: ${error}`;
                                }
                            })
                            .processOCRImage(base64Data);
                    } else {
                        // ローカル環境でのモック
                        console.log('ローカル環境: OCR処理をシミュレートします');
                        setTimeout(() => {
                            if (screenshotStatus) screenshotStatus.classList.add('d-none');
                            
                            if (screenshotResult && screenshotResultText) {
                                screenshotResult.classList.remove('d-none');
                                screenshotResult.querySelector('div').className = 'alert alert-success';
                                screenshotResultText.textContent = `成功: 3件のメッセージを保存しました。(ローカル環境シミュレーション)`;
                                
                                setTimeout(() => {
                                    if (removeScreenshotBtn) removeScreenshotBtn.click();
                                }, 1000);
                            }
                        }, 2000);
                    }
                });
            }
            
            // HTML処理関連
            const htmlContent = document.getElementById('htmlContent');
            const htmlUpload = document.getElementById('htmlUpload');
            const htmlDropZone = document.getElementById('htmlDropZone');
            const htmlFileInfo = document.getElementById('html-file-info');
            const htmlFileName = document.getElementById('html-file-name');
            const processHtmlBtn = document.getElementById('process-html');
            const htmlStatus = document.getElementById('html-status');
            const htmlResult = document.getElementById('html-result');
            const htmlResultText = document.getElementById('html-result-text');
            
            let htmlFileContent = null;
            
            // HTMLドラッグ&ドロップのイベント設定
            if (htmlDropZone) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    htmlDropZone.addEventListener(eventName, preventDefaults, false);
                });
                
                ['dragenter', 'dragover'].forEach(eventName => {
                    htmlDropZone.addEventListener(eventName, function() {
                        htmlDropZone.classList.add('border-primary');
                    }, false);
                });
                
                ['dragleave', 'drop'].forEach(eventName => {
                    htmlDropZone.addEventListener(eventName, function() {
                        htmlDropZone.classList.remove('border-primary');
                    }, false);
                });
                
                // ドロップ時の処理
                htmlDropZone.addEventListener('drop', function(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    handleHtmlFiles(files);
                }, false);
            }
            
            // HTMLファイルアップロード処理
            if (htmlUpload) {
                htmlUpload.addEventListener('change', function() {
                    handleHtmlFiles(this.files);
                });
            }
            
            // HTMLファイル処理
            function handleHtmlFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.html') || file.name.endsWith('.htm')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            htmlFileContent = e.target.result;
                            
                            // ファイル情報を表示
                            if (htmlFileInfo && htmlFileName) {
                                htmlFileName.textContent = file.name;
                                htmlFileInfo.classList.remove('d-none');
                            }
                            
                            // テキストエリアにも内容を表示（テキスト入力との連携のため）
                            if (htmlContent) {
                                htmlContent.value = htmlFileContent;
                            }
                        };
                        
                        reader.readAsText(file);
                    } else {
                        alert('HTMLファイル(.html, .htm)を選択してください');
                    }
                }
            }
            
            // HTML処理ボタン
            if (processHtmlBtn) {
                processHtmlBtn.addEventListener('click', function() {
                    // ファイルアップロードとテキスト入力のどちらからでもコンテンツを取得
                    let content = htmlContent.value.trim();
                    
                    // ファイルアップロードのコンテンツがある場合はそちらを優先
                    if (htmlFileContent) {
                        content = htmlFileContent;
                    }
                    
                    if (!content) {
                        alert('HTMLを入力またはファイルをアップロードしてください');
                        return;
                    }
                    
                    // 処理中表示
                    if (htmlStatus) htmlStatus.classList.remove('d-none');
                    if (htmlResult) htmlResult.classList.add('d-none');
                    
                    // サーバー側処理を呼び出し
                    if (typeof google !== 'undefined' && google.script && google.script.run) {
                        google.script.run
                            .withSuccessHandler(function(result) {
                                // 処理中表示を非表示
                                if (htmlStatus) htmlStatus.classList.add('d-none');
                                
                                // 結果表示
                                if (htmlResult && htmlResultText) {
                                    if (result.success) {
                                        htmlResult.classList.remove('d-none');
                                        htmlResult.querySelector('div').className = 'alert alert-success';
                                        htmlResultText.textContent = `成功: ${result.messageCount}件のメッセージを保存しました。`;
                                        
                                        // 顧客リストを更新
                                        updateCustomerList();
                                        
                                        // 処理完了したらフィールドをクリア
                                        setTimeout(() => {
                                            resetHtmlFields();
                                        }, 1000);
                                    } else {
                                        htmlResult.classList.remove('d-none');
                                        htmlResult.querySelector('div').className = 'alert alert-danger';
                                        htmlResultText.textContent = `エラー: ${result.error}`;
                                    }
                                }
                            })
                            .withFailureHandler(function(error) {
                                // 処理中表示を非表示
                                if (htmlStatus) htmlStatus.classList.add('d-none');
                                
                                // エラー表示
                                if (htmlResult && htmlResultText) {
                                    htmlResult.classList.remove('d-none');
                                    htmlResult.querySelector('div').className = 'alert alert-danger';
                                    htmlResultText.textContent = `エラー: ${error}`;
                                }
                            })
                            .processHTMLContent(content);
                    } else {
                        // ローカル環境でのモック
                        console.log('ローカル環境: HTML処理をシミュレートします');
                        setTimeout(() => {
                            if (htmlStatus) htmlStatus.classList.add('d-none');
                            
                            if (htmlResult && htmlResultText) {
                                htmlResult.classList.remove('d-none');
                                htmlResult.querySelector('div').className = 'alert alert-success';
                                htmlResultText.textContent = `成功: 5件のメッセージを保存しました。(ローカル環境シミュレーション)`;
                                
                                // 顧客リストは更新しない（ローカル環境ではダミーデータを使用）
                                
                                setTimeout(() => {
                                    resetHtmlFields();
                                }, 1000);
                            }
                        }, 2000);
                    }
                });
            }
            
            // HTMLフィールドをリセットする関数
            function resetHtmlFields() {
                if (htmlContent) htmlContent.value = '';
                if (htmlUpload) htmlUpload.value = '';
                htmlFileContent = null;
                if (htmlFileInfo) htmlFileInfo.classList.add('d-none');
            }
            
            // 顧客リストを更新する関数
            function updateCustomerList() {
                google.script.run.withSuccessHandler(function(customers) {
                    // 顧客リストを再生成
                    generateCustomerList(customers);
                    
                    // 顧客IDが存在し、現在選択されていなければ初期表示
                    if (Object.keys(customers).length > 0 && !currentCustomerId) {
                        currentCustomerId = Object.keys(customers)[0];
                        updateCustomerView(currentCustomerId);
                    } else if (currentCustomerId) {
                        // 現在選択されている顧客があれば、その顧客ビューを更新
                        updateCustomerView(currentCustomerId);
                    }
                }).getCustomers();
            }
            
            // ダミーメソッドを拡張（ローカル環境テスト用）
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                // ダミーのOCR処理
                google.script.run.processOCRImage = function(base64Data) {
                    console.log('[ダミー] processOCRImage 呼び出し');
                    if (this._successHandler) {
                        setTimeout(() => {
                            try {
                                this._successHandler({
                                    success: true,
                                    customerId: "instagram_" + new Date().getTime(),
                                    messageCount: 3
                                });
                            } catch (e) {
                                console.error("Success handler for processOCRImage failed:", e);
                                if (this._failureHandler) this._failureHandler(e);
                            }
                            this._successHandler = null;
                            this._failureHandler = null;
                        }, 2000);
                    } else {
                        this._successHandler = null;
                        this._failureHandler = null;
                    }
                    return this;
                };
                
                // ダミーのHTML処理
                google.script.run.processHTMLContent = function(htmlContent) {
                    console.log('[ダミー] processHTMLContent 呼び出し');
                    if (this._successHandler) {
                        setTimeout(() => {
                            try {
                                this._successHandler({
                                    success: true,
                                    customerId: "instagram_" + new Date().getTime(),
                                    messageCount: 5
                                });
                            } catch (e) {
                                console.error("Success handler for processHTMLContent failed:", e);
                                if (this._failureHandler) this._failureHandler(e);
                            }
                            this._successHandler = null;
                            this._failureHandler = null;
                        }, 2000);
                    } else {
                        this._successHandler = null;
                        this._failureHandler = null;
                    }
                    return this;
                };
            }
        });

        // 返信候補を表示
        function displayReplySuggestions(suggestions) {
            const suggestionsContainer = document.getElementById('reply-suggestions');
            
            if (!suggestionsContainer) return;
            
            // 一旦クリア
            suggestionsContainer.innerHTML = '';
            
            // 返信候補がない場合はコンテナを非表示に
            const suggestionsParent = document.getElementById('reply-suggestions-container');
            if (!suggestions || !suggestions.length) {
                if (suggestionsParent) suggestionsParent.style.display = 'none';
                return;
            }
            
            // 返信候補を表示
            if (suggestionsParent) suggestionsParent.style.display = 'block';
            
            // 返信候補ボタンを追加
            suggestions.forEach(suggestion => {
                const btn = document.createElement('button');
                btn.className = 'reply-suggestion';
                btn.textContent = suggestion;
                btn.addEventListener('click', () => {
                    const messageInput = document.getElementById('message-input');
                    if (messageInput) {
                        messageInput.value = suggestion;
                        messageInput.focus();
                        // 送信ボタンを有効化
                        const sendButton = document.getElementById('send-message-btn');
                        if (sendButton) sendButton.disabled = false;
                    }
                });
                suggestionsContainer.appendChild(btn);
            });
        }
    </script>
</body>
</html>